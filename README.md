# Умный фильтр

Компонент предназначен для парсинга строки с ЧПУ фильтром и генерации массива фильтров. Сгенерированные фильтры можно передавать в GetList без дополнительной обработки.

Результирующий массив состоит из двух ключей - products и offers. offers заполняется автоматически, если инфоблок продуктов - это инфоблок, являющийся каталогом и имеющий инфоблок с торговыми предложениями.

***

## Как работает фильтр и как с ним работать

Работа фильтра основана на фасетном индексе - по сути это просто sql индексы, просто немного сложнее и с использованием API битрикса.
Для нормальной работы фильтра надо создать фасетные индексы, настроить свойства и правильно передать параметры.

### Параметры фильтра

- **IBLOCK_ID** - ***обязательный*** параметр, указывается ID инфоблока, с которым будет работать фильтр.
- **FILTER_URL** - строка вида "test/1/test2/2-3/", в которой передаются фильтры. Множественные значения (чекбоксы, радио кнопки, цена от и до) разделяются знаком "-"
- **PRICE** - массив для настройки работы с ценами. ***Без этого парамтера цены игнорируются***. В этот параметр могут входить следующие ключи:
	- **TITLE** - подпись поля в фильтре (обычно "Цена")
	- **FIELD** - название поля с ценой - ключ, по которому будет искаться цена в строке URL. Этот же ключ будет передаваться в результирующий массив с фильтрами.
	- **SORT**  - сортировка, для остальных полей задается в админке в настройках инфоблока
- ***SECTION_ID*** или ***SECTION_CODE*** - ID или CODE раздела соответственно. На сколько я понял, ни на что не влияют, но в фасетном индексе битрикса используются =)

### Фасетные индексы

При создании свойств инфоблока (возможно еще в каких то случаях) битрикс начинает показывать предупреждение, что надо создать новый фасетный индекс. Надо нажать на ссылку в предупреждении и создать этот индекс. Так же можно перейти в админке на страницу ***/bitrix/admin/iblock_reindex_admin.php?lang=ru*** и создать там индексы. Эти индексы надо создавать каждый раз, когда создается свойство (возможно и в других случаях, в общем, каждый раз, когда битрикс этого требует).

### Подключение свойств в фильтр

Чтобы свойство отображалось в фильтре, надо его настроить - в админке, в настройках свойств инфоблока зайти в расширенные настройки конкретного свойства (нажать "...") и поставить галочку ***"Показывать в умном фильтре"***.

Так же можно выбрать, в каком виде будет отображаться это свойство - флажки, радиокнопки, выпадающий список.

***Чтобы свойство работало, обязательно нужно указать свойству символьный код (CODE).***

Если, есть свойства, которые необходимо отобразить в фильтре, но для них нельзя включить фасетные индексы, то их можно передать в параметре **ADDITIONAL_PROPERTIES**
### Пример подключения фильтра

```php
// подключаем фильтр и записываем возвращаемые значения в переменную $filter
// в $_GET['_filter'] хранится строка фильтра, полученная с помощью правильно настроенного . Вместо этого может быть другая переменная.
$filter = $APPLICATION->IncludeCOmponent(
	'odva:smart.filter',
	'',
	[
		'IBLOCK_ID'  => 7,
		'PRICE'      => [
			'TITLE' => 'Цена',
			'FIELD' => 'price'
		],
		'FILTER_URL' => $_GET['_filter'],
		'ADDITIONAL_PROPERTIES' => ['>CATALOG_QUANTITY', 'PROPERTY_BESTSALLER_VALUE']
	]
);

// передаем фильтр в другой компонент
// важно помнить, что $filter - массив с двумя ключами - products и offers
// по умолчанию (если нет торговых предложений) заполняется только products
$APPLICATION->IncludeCOmponent(
	'odva:elements',
	'',
	[
		'filter'       => $filter['products']
	]
);
```

***Визуальное отображение фильтров, в том числе получение возможных значений для каждого свойства, получение типа отображения и т.д. можно посмотреть в шаблоне .default, расположенном вместе с компонентом.***
